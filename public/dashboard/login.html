<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login | Baba Banarasi - Varanasi Scooter Darshan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Login to your Baba Banarasi account" />
  <meta name="theme-color" content="#EA580C" />
  <link rel="icon" type="image/png" href="/logo.png" />
  
  <!-- Security Headers -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- EXACT SAME DESIGN AS BEFORE --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --primary: #EA580C; --primary-dark: #C2410C; --radius: 12px; --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 50%, #FED7AA 100%); min-height: 100vh; display: flex; color: #1F2937; }
    .brand-panel { display: none; width: 50%; background: linear-gradient(135deg, #EA580C 0%, #C2410C 100%); padding: 60px; color: white; justify-content: center; flex-direction: column; }
    @media (min-width: 1024px) { .brand-panel { display: flex; } }
    .form-panel { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .login-container { width: 100%; max-width: 450px; }
    .card { background: white; border-radius: var(--radius); box-shadow: var(--shadow-xl); overflow: hidden; padding: 40px; position: relative; }
    h1 { font-family: 'Noto Sans Devanagari', sans-serif; font-size: 2.5rem; margin-bottom: 10px; }
    h2 { font-size: 1.75rem; color: #111827; margin-bottom: 8px; text-align: center; }
    .subtitle { color: #6B7280; text-align: center; margin-bottom: 30px; font-size: 0.95rem; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
    input { width: 100%; padding: 12px 16px; border: 1.5px solid #E5E7EB; border-radius: var(--radius); font-size: 1rem; transition: all 0.2s; }
    input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(234, 88, 12, 0.1); }
    .submit-btn { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; font-size: 1rem; transition: transform 0.2s; }
    .submit-btn:hover { transform: translateY(-2px); background: var(--primary-dark); }
    .submit-btn:disabled { opacity: 0.7; cursor: not-allowed; }
    .google-btn { width: 100%; padding: 12px; background: white; border: 1.5px solid #E5E7EB; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; font-weight: 500; margin-bottom: 24px; transition: background 0.2s; }
    .google-btn:hover { background: #F9FAFB; }
    .divider { text-align: center; border-bottom: 1px solid #E5E7EB; line-height: 0.1em; margin: 30px 0; color: #9CA3AF; }
    .divider span { background:#fff; padding:0 10px; }
    .toggle { text-align: center; margin-top: 24px; font-size: 0.9rem; }
    .toggle a { color: var(--primary); text-decoration: none; font-weight: 600; cursor: pointer; }
    .alert { padding: 12px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; display: none; }
    .alert.error { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; display: block; }
    .alert.success { background: #F0FDF4; color: #16A34A; border: 1px solid #BBF7D0; display: block; }
    .mobile-header { text-align: center; margin-bottom: 30px; display: block; }
    @media (min-width: 1024px) { .mobile-header { display: none; } }
    .logo-text { font-size: 2rem; font-weight: bold; color: var(--primary); font-family: 'Noto Sans Devanagari', sans-serif; }
    
    /* Loading Spinner */
    .btn-spinner { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="brand-panel">
    <!-- SECURE IMAGE LOADING -->
    <img src="/logo.png" alt="Logo" style="width: 120px; height: 120px; object-fit: contain; background: white; border-radius: 50%; padding: 10px; margin-bottom: 20px;">
    <h1>à¤¬à¤¾à¤¬à¤¾ à¤¬à¤¨à¤¾à¤°à¤¸à¥€</h1>
    <p style="font-size: 1.2rem; opacity: 0.9;">Experience the Soul of Varanasi on Two Wheels</p>
    <div style="margin-top: 40px; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
      <p><i>"The most authentic way to experience Banaras. Truly magical!"</i></p>
      <p style="margin-top: 10px; font-weight: 600;">- Rahul Sharma</p>
    </div>
  </div>

  <div class="form-panel">
    <div class="login-container">
      
      <div class="mobile-header">
        <img src="/logo.png" alt="Logo" style="width: 80px; height: 80px; margin-bottom: 10px; object-fit: contain;">
        <div class="logo-text">à¤¬à¤¾à¤¬à¤¾ à¤¬à¤¨à¤¾à¤°à¤¸à¥€</div>
        <p>Scooter Darshan</p>
      </div>

      <div class="card">
        <h2 id="formTitle">Welcome Back</h2>
        <p class="subtitle" id="formSubtitle">Sign in to continue</p>

        <!-- SECURE MESSAGE BOX (Text Content Only) -->
        <div id="messageBox" class="alert"></div>

        <button class="google-btn" id="googleBtn" type="button">
          <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continue with Google
        </button>

        <div class="divider"><span>or with email</span></div>

        <form id="authForm" novalidate>
          <div class="form-group" id="nameGroup" style="display: none;">
            <label for="name">Full Name</label>
            <input type="text" id="name" name="name" placeholder="Rahul Kumar" autocomplete="name">
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" placeholder="you@example.com" required autocomplete="email">
          </div>

          <div class="form-group">
            <label for="password">Password</label>
            <input type="password" id="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autocomplete="current-password">
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">Sign In</button>
        </form>

        <div class="toggle">
          <span id="toggleText">Don't have an account?</span>
          <a id="toggleLink">Create one</a>
        </div>
      </div>
    </div>
  </div>

<!-- SECURE JAVASCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { 
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
  signInWithPopup, GoogleAuthProvider, updateProfile 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCtyR68dG9TEI_C89PvsdrGmpkE6vCtV0s",
  authDomain: "varanasi-scoot-darshan.firebaseapp.com",
  projectId: "varanasi-scoot-darshan",
  storageBucket: "varanasi-scoot-darshan.firebasestorage.app",
  messagingSenderId: "437910870938",
  appId: "1:437910870938:web:cb7b3043bcc39216143823"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const googleProvider = new GoogleAuthProvider();

// --- ðŸ”’ STAFF EMAILS (SECURE CHECK HAPPENS IN DB TOO) ---
const STAFF = {
  super_admin: ['shivampandit2006@gmail.com'],
  admin: ['aruneshsinghrajawat@gmail.com'],
  manager: ['anshumanjha3333@gmail.com']
};

let isLoginMode = true;

// UI Helpers
const $ = id => document.getElementById(id);

function showMessage(msg, type) {
  const box = $('messageBox');
  // ðŸ”’ SECURITY: Use textContent to prevent XSS attacks
  box.textContent = msg; 
  box.className = `alert ${type}`;
}

// ðŸ”’ INPUT SANITIZATION
function sanitize(input) {
  if (!input) return '';
  return input.replace(/[<>]/g, ''); // Removes potential script tags
}

// ðŸ”’ ROBUST REDIRECT SYSTEM
async function handleRedirect(user) {
  try {
    let role = 'user';
    
    // Check local list first (Fast)
    if(STAFF.super_admin.includes(user.email)) role = 'super_admin';
    else if(STAFF.admin.includes(user.email)) role = 'admin';
    else if(STAFF.manager.includes(user.email)) role = 'manager';

    // ðŸ”’ Double check DB for role persistence
    const userRef = doc(db, 'users', user.uid);
    const userDoc = await getDoc(userRef);
    
    if (userDoc.exists() && userDoc.data().role) {
      // Trust Database Role over Email list if it exists (More secure)
      role = userDoc.data().role;
    } else {
      // First time login - Save to DB
      await setDoc(userRef, {
        uid: user.uid,
        email: user.email,
        displayName: user.displayName || user.email.split('@')[0],
        role: role,
        lastLogin: new Date().toISOString()
      }, { merge: true });
    }

    showMessage(`Welcome, ${user.displayName || 'Traveler'}!`, 'success');

    // ðŸ”’ PREVENT REDIRECT LOOPS
    setTimeout(() => {
      if (role === 'user') {
        window.location.href = '/'; 
      } else {
        const target = `/dashboard/${role === 'super_admin' ? 'admin' : role}.html`;
        window.location.href = target;
      }
    }, 1000);

  } catch (error) {
    console.error("Redirect logic error:", error);
    showMessage("Login successful, but redirect failed. Refreshing...", "error");
    setTimeout(() => window.location.href = '/', 2000);
  }
}

// --- EVENTS ---
$('toggleLink').addEventListener('click', (e) => {
  e.preventDefault();
  isLoginMode = !isLoginMode;
  $('formTitle').textContent = isLoginMode ? 'Welcome Back' : 'Create Account';
  $('submitBtn').textContent = isLoginMode ? 'Sign In' : 'Create Account';
  $('toggleText').textContent = isLoginMode ? "Don't have an account?" : "Already have an account?";
  $('toggleLink').textContent = isLoginMode ? "Create one" : "Sign In";
  $('nameGroup').style.display = isLoginMode ? 'none' : 'block';
  $('messageBox').style.display = 'none';
});

$('authForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = $('submitBtn');
  
  // ðŸ”’ PREVENT DOUBLE SUBMISSION
  if (btn.disabled) return;
  
  btn.disabled = true; 
  btn.innerHTML = '<div class="btn-spinner"></div>';
  
  const email = sanitize($('email').value.trim());
  const password = $('password').value;
  const name = sanitize($('name').value.trim());

  // ðŸ”’ VALIDATION
  if (!email || !password) {
    showMessage("Please fill all fields", 'error');
    btn.disabled = false;
    btn.textContent = isLoginMode ? 'Sign In' : 'Create Account';
    return;
  }

  try {
    let result;
    if (isLoginMode) {
      result = await signInWithEmailAndPassword(auth, email, password);
    } else {
      if (!name) throw new Error("Please enter your name");
      if (password.length < 6) throw new Error("Password must be at least 6 characters");
      
      result = await createUserWithEmailAndPassword(auth, email, password);
      await updateProfile(result.user, { displayName: name });
    }
    await handleRedirect(result.user);
  } catch (error) {
    // ðŸ”’ CLEAN ERROR MESSAGES
    let msg = error.message.replace('Firebase:', '').replace(/\(auth\/.*\)/, '').trim();
    if (msg.includes('invalid-credential')) msg = "Incorrect email or password.";
    if (msg.includes('email-already-in-use')) msg = "Email already registered. Try logging in.";
    
    showMessage(msg, 'error');
    btn.disabled = false;
    btn.textContent = isLoginMode ? 'Sign In' : 'Create Account';
  }
});

$('googleBtn').addEventListener('click', async () => {
  try {
    const result = await signInWithPopup(auth, googleProvider);
    await handleRedirect(result.user);
  } catch (error) {
    if (error.code === 'auth/popup-closed-by-user') return; // Ignore if user closed popup
    showMessage("Google Sign-In failed. Try again.", 'error');
  }
});
</script>
</body>
</html>
