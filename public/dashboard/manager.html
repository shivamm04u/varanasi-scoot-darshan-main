<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Dashboard | Varanasi Scoot Darshan</title>
  <!-- Google Fonts: Inter for UI -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Brand Colors */
      --primary: #FF6B35; /* Varanasi Orange */
      --primary-hover: #E85A2A;
      --secondary: #2E3A59; /* Deep River Blue */
      
      /* UI Colors - Optimized for reduced eye strain */
      --bg-body: #F3F4F6;
      --bg-sidebar: #1E293B;
      --surface: #FFFFFF;
      --border: #E2E8F0;
      
      /* Text Colors */
      --text-main: #1F2937;
      --text-muted: #64748B;
      --text-light: #F8FAFC;
      
      /* Status Colors */
      --success-bg: #DCFCE7;
      --success-text: #166534;
      --warning-bg: #FEF3C7;
      --warning-text: #92400E;
      --danger-bg: #FEE2E2;
      --danger-text: #991B1B;
      --info-bg: #E0F2FE;
      --info-text: #075985;

      /* Shadows */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 260px;
      background-color: var(--bg-sidebar);
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease;
      z-index: 50;
      box-shadow: 4px 0 24px rgba(0,0,0,0.1);
    }

    .brand {
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .brand i {
      font-size: 1.5rem;
      color: var(--primary);
      background: rgba(255, 107, 53, 0.1);
      padding: 8px;
      border-radius: 8px;
    }

    .brand span {
      font-weight: 700;
      font-size: 1.1rem;
      letter-spacing: -0.5px;
    }

    .user-mini-profile {
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(0,0,0,0.2);
    }

    .avatar {
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: white;
    }

    .user-info h4 { font-size: 0.9rem; font-weight: 600; }
    .user-info p { font-size: 0.75rem; color: #94A3B8; }

    .nav-menu {
      padding: 1rem;
      flex: 1;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0.85rem 1rem;
      color: #CBD5E1;
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 4px;
      transition: all 0.2s;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.95rem;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: white;
    }

    .nav-item.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
    }

    .nav-item .badge {
      margin-left: auto;
      background: var(--danger-text);
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .bottom-actions {
      padding: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .logout-btn {
      width: 100%;
      padding: 0.75rem;
      background: transparent;
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #FCA5A5;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.1);
      color: #EF4444;
      border-color: #EF4444;
    }

    /* --- MAIN CONTENT --- */
    .main-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .top-header {
      background: var(--surface);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      height: 70px;
    }

    .page-title h2 {
      font-size: 1.25rem;
      color: var(--text-main);
      font-weight: 700;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
    }

    .btn-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .content-area {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
    }

    /* --- DASHBOARD CARDS --- */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 1.5rem;
      transition: transform 0.2s;
    }

    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

    .stat-icon-box {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .bg-orange { background: #FFF7ED; color: var(--primary); }
    .bg-blue { background: #EFF6FF; color: #3B82F6; }
    .bg-green { background: #F0FDF4; color: #22C55E; }
    .bg-purple { background: #FAF5FF; color: #A855F7; }

    .stat-details h3 { font-size: 1.8rem; font-weight: 700; color: var(--text-main); line-height: 1.2; }
    .stat-details p { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; }

    /* --- TABLES --- */
    .card {
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .card-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h3 { font-size: 1.1rem; font-weight: 600; }

    .table-container { overflow-x: auto; }
    
    table { width: 100%; border-collapse: collapse; }
    
    th {
      background: #F8FAFC;
      padding: 1rem 1.5rem;
      text-align: left;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    td {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
      color: var(--text-main);
    }

    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #F8FAFC; }

    /* --- BADGES & BUTTONS --- */
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-pending { background: var(--warning-bg); color: var(--warning-text); }
    .status-confirmed { background: var(--success-bg); color: var(--success-text); }
    .status-completed { background: var(--info-bg); color: var(--info-text); }
    .status-cancelled { background: var(--danger-bg); color: var(--danger-text); }

    .btn-primary {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .btn-primary:hover { background: var(--primary-hover); }

    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
    .btn-outline { border: 1px solid var(--border); background: white; color: var(--text-main); }
    .btn-outline:hover { background: #F8FAFC; border-color: #CBD5E1; }

    /* --- EDITOR GRID --- */
    .editor-layout {
      display: grid;
      grid-template-columns: 1fr 350px;
      gap: 2rem;
    }

    /* --- PACKAGES --- */
    .package-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.2rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 1rem;
      background: white;
      transition: all 0.2s;
    }
    
    .package-card:hover { border-color: var(--primary); box-shadow: var(--shadow-sm); }

    .pkg-info h4 { font-weight: 600; margin-bottom: 4px; }
    .pkg-info p { font-size: 0.85rem; color: var(--text-muted); }
    .pkg-price { font-weight: 700; color: var(--primary); font-size: 1.1rem; }

    /* --- IMAGES --- */
    .image-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .img-tile {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 4/3;
      border: 1px solid var(--border);
      group:hover;
    }

    .img-tile img { width: 100%; height: 100%; object-fit: cover; }
    
    .img-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .img-tile:hover .img-overlay { opacity: 1; }
    
    .img-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 0.75rem;
      padding: 4px 8px;
      text-align: center;
    }

    /* --- FORMS --- */
    .form-group { margin-bottom: 1.25rem; }
    .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-main); }
    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1); }
    textarea.form-control { min-height: 100px; resize: vertical; }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- LOADING --- */
    .loader-container {
      position: fixed;
      inset: 0;
      background: white;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* --- MODAL --- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .modal-backdrop.active { opacity: 1; pointer-events: auto; }
    .modal-content {
      background: white;
      width: 90%;
      max-width: 500px;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: var(--shadow-lg);
      transform: scale(0.95);
      transition: transform 0.2s;
    }
    .modal-backdrop.active .modal-content { transform: scale(1); }
    
    /* Responsive */
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: -260px; height: 100%; }
      .sidebar.open { left: 0; }
      .editor-layout { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- LOADING SCREEN -->
  <div id="loader" class="loader-container">
    <div class="spinner"></div>
    <p style="margin-top: 1rem; color: var(--text-muted); font-weight: 500;">Accessing Command Center...</p>
  </div>

  <!-- TOAST NOTIFICATION (Replaces Alert) -->
  <div id="toast" style="position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; background: var(--bg-sidebar); color: white; border-radius: 8px; box-shadow: var(--shadow-lg); transform: translateX(150%); transition: transform 0.3s; z-index: 1000; display: flex; align-items: center; gap: 10px;">
    <i id="toastIcon" class="fas fa-check-circle"></i>
    <span id="toastMsg">Operation Successful</span>
  </div>

  <div class="hidden" id="mainApp" style="width: 100%; display: flex;">
    
    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
      <div class="brand">
        <i class="fas fa-motorcycle"></i>
        <span>Scoot Darshan</span>
      </div>

      <div class="user-mini-profile">
        <div class="avatar">M</div>
        <div class="user-info">
          <h4 id="userNameDisplay">Manager</h4>
          <p id="userEmailDisplay">Loading...</p>
        </div>
      </div>

      <div class="nav-menu">
        <div class="nav-item active" onclick="switchTab('dashboard')">
          <i class="fas fa-chart-pie" style="width: 20px;"></i> <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="switchTab('bookings')">
          <i class="fas fa-clipboard-list" style="width: 20px;"></i> <span>Bookings</span>
          <span class="badge hidden" id="pendingCountBadge">0</span>
        </div>
        <div class="nav-item" onclick="switchTab('editor')">
          <i class="fas fa-pen-nib" style="width: 20px;"></i> <span>Website Editor</span>
        </div>
        <div class="nav-item" onclick="switchTab('settings')">
          <i class="fas fa-cog" style="width: 20px;"></i> <span>Settings</span>
        </div>
        <div class="nav-item" onclick="goToSite()">
          <i class="fas fa-external-link-alt" style="width: 20px;"></i> <span>View Live Site</span>
        </div>
      </div>

      <div class="bottom-actions">
        <button class="logout-btn" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <div class="main-wrapper">
      <header class="top-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
          <button class="btn-icon" id="menuToggle" style="display: none;"><i class="fas fa-bars"></i></button>
          <div class="page-title">
            <h2 id="pageTitle">Overview</h2>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn-icon" onclick="refreshData()" title="Refresh Data"><i class="fas fa-sync-alt"></i></button>
        </div>
      </header>

      <main class="content-area">
        
        <!-- DASHBOARD TAB -->
        <div id="dashboardTab" class="tab-content fade-in">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon-box bg-orange"><i class="fas fa-box"></i></div>
              <div class="stat-details">
                <h3 id="statTotal">0</h3>
                <p>Total Bookings</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-box bg-blue"><i class="fas fa-clock"></i></div>
              <div class="stat-details">
                <h3 id="statPending">0</h3>
                <p>Pending Action</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-box bg-green"><i class="fas fa-check-circle"></i></div>
              <div class="stat-details">
                <h3 id="statConfirmed">0</h3>
                <p>Confirmed</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon-box bg-purple"><i class="fas fa-rupee-sign"></i></div>
              <div class="stat-details">
                <h3 id="statRevenue">₹0</h3>
                <p>Est. Revenue</p>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3>Recent Bookings</h3>
              <button class="btn-primary btn-sm btn-outline" onclick="switchTab('bookings')">View All</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Customer</th>
                    <th>Package</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody id="dashboardTableBody">
                  <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- BOOKINGS TAB -->
        <div id="bookingsTab" class="tab-content hidden fade-in">
          <div class="card">
            <div class="card-header">
              <div style="display: flex; gap: 10px;">
                <button class="btn-primary btn-sm" onclick="filterBookings('all')">All</button>
                <button class="btn-primary btn-sm btn-outline" onclick="filterBookings('pending')">Pending</button>
                <button class="btn-primary btn-sm btn-outline" onclick="filterBookings('confirmed')">Confirmed</button>
              </div>
              <button class="btn-primary btn-sm btn-outline" onclick="exportCSV()"><i class="fas fa-download"></i> Export</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Details</th>
                    <th>Contact</th>
                    <th>Package Info</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="bookingsTableBody">
                  <!-- JS Populated -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- EDITOR TAB -->
        <div id="editorTab" class="tab-content hidden fade-in">
          
          <!-- Auto Fix Button (Shows only if no packages) -->
          <div id="seedDataAlert" style="background: var(--warning-bg); color: var(--warning-text); padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: none; align-items: center; justify-content: space-between;">
            <span><i class="fas fa-exclamation-triangle"></i> No packages found. Initialize Varanasi Default Data?</span>
            <button class="btn-primary btn-sm" onclick="seedDefaultPackages()">Initialize Data</button>
          </div>

          <div class="editor-layout">
            <!-- Left Col: Packages & Images -->
            <div>
              <div class="card">
                <div class="card-header">
                  <h3><i class="fas fa-tag"></i> Tour Packages</h3>
                  <button class="btn-primary btn-sm" onclick="openPackageModal()">+ Add New</button>
                </div>
                <div style="padding: 1.5rem;" id="packagesList">
                  <p style="text-align:center; color: var(--text-muted);">Loading packages...</p>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h3><i class="fas fa-images"></i> Website Gallery</h3>
                  <small style="color: var(--text-muted);">Click image to replace</small>
                </div>
                <div style="padding: 1.5rem;">
                  <div class="image-grid" id="imageGallery">
                    <!-- Images loaded here -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Col: Settings -->
            <div>
              <div class="card">
                <div class="card-header"><h3><i class="fas fa-address-card"></i> Contact Info</h3></div>
                <div style="padding: 1.5rem;">
                  <div class="form-group">
                    <label>Phone</label>
                    <input type="text" id="editPhone" class="form-control" placeholder="+91...">
                  </div>
                  <div class="form-group">
                    <label>WhatsApp</label>
                    <input type="text" id="editWhatsapp" class="form-control">
                  </div>
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="editEmail" class="form-control">
                  </div>
                  <button class="btn-primary" style="width: 100%;" onclick="saveContactInfo()">Update Contact</button>
                </div>
              </div>

              <div class="card">
                <div class="card-header"><h3><i class="fas fa-sliders-h"></i> Availability</h3></div>
                <div style="padding: 1.5rem;">
                  <div class="form-group">
                    <label>Booking Status</label>
                    <select id="editStatus" class="form-control">
                      <option value="open">Open</option>
                      <option value="busy">High Demand</option>
                      <option value="closed">Closed</option>
                    </select>
                  </div>
                  <button class="btn-primary btn-outline" style="width: 100%;" onclick="saveAvailability()">Update Status</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settingsTab" class="tab-content hidden fade-in">
          <div class="card" style="max-width: 600px; margin: 0 auto;">
            <div class="card-header"><h3>Profile & Security</h3></div>
            <div style="padding: 2rem;">
              <div class="form-group">
                <label>Manager Name</label>
                <input type="text" id="profileName" class="form-control">
              </div>
              <button class="btn-primary" onclick="updateProfile()">Save Profile</button>
              
              <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">
              
              <h4 style="margin-bottom: 1rem; color: var(--danger-text);">Change Password</h4>
              <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPass" class="form-control">
              </div>
              <button class="btn-primary" style="background: var(--danger-text);" onclick="changePassword()">Update Password</button>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- MODALS -->
  
  <!-- Package Modal -->
  <div class="modal-backdrop" id="packageModal">
    <div class="modal-content">
      <h3 style="margin-bottom: 1.5rem;" id="pkgModalTitle">Add Package</h3>
      <input type="hidden" id="pkgId">
      <div class="form-group">
        <label>Package Name</label>
        <input type="text" id="pkgName" class="form-control" placeholder="e.g. Subah-e-Banaras">
      </div>
      <div class="form-group">
        <label>Price (₹)</label>
        <input type="number" id="pkgPrice" class="form-control" placeholder="1500">
      </div>
      <div class="form-group">
        <label>Duration</label>
        <input type="text" id="pkgDuration" class="form-control" placeholder="e.g. 3 Hours">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="pkgDesc" class="form-control"></textarea>
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn-primary btn-outline" onclick="closeModal('packageModal')">Cancel</button>
        <button class="btn-primary" onclick="savePackage()">Save Package</button>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="modal-backdrop" id="imageModal">
    <div class="modal-content">
      <h3 style="margin-bottom: 1rem;">Replace Image</h3>
      <p style="margin-bottom: 1rem; color: var(--text-muted);" id="imgModalLabel"></p>
      <input type="hidden" id="imgKey">
      <div class="form-group">
        <label>New Image URL</label>
        <input type="text" id="newImgUrl" class="form-control" placeholder="https://..." onchange="document.getElementById('imgPreview').src = this.value">
      </div>
      <div style="margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; height: 150px;">
        <img id="imgPreview" src="" style="width: 100%; height: 100%; object-fit: cover;">
      </div>
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn-primary btn-outline" onclick="closeModal('imageModal')">Cancel</button>
        <button class="btn-primary" onclick="saveImage()">Update Image</button>
      </div>
    </div>
  </div>

  <!-- FIREBASE LOGIC -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, updatePassword, updateProfile as authUpdateProfile } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, query, doc, updateDoc, getDoc, setDoc, deleteDoc, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCtyR68dG9TEI_C89PvsdrGmpkE6vCtV0s",
      authDomain: "varanasi-scoot-darshan.firebaseapp.com",
      projectId: "varanasi-scoot-darshan",
      storageBucket: "varanasi-scoot-darshan.firebasestorage.app",
      messagingSenderId: "437910870938",
      appId: "1:437910870938:web:cb7b3043bcc39216143823"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let bookingsData = [];
    let websiteSettings = {};

    // --- UI HELPERS ---
    window.showToast = (msg, type = 'success') => {
      const toast = document.getElementById('toast');
      const icon = document.getElementById('toastIcon');
      const text = document.getElementById('toastMsg');
      
      toast.style.background = type === 'success' ? '#1E293B' : '#EF4444';
      icon.className = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
      text.textContent = msg;
      
      toast.style.transform = 'translateX(0)';
      setTimeout(() => toast.style.transform = 'translateX(150%)', 3000);
    };

    window.switchTab = (tabId) => {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(tabId + 'Tab').classList.remove('hidden');
      
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      event.currentTarget.classList.add('active'); // Needs event passed or find by logic
      
      const titles = { 'dashboard': 'Overview', 'bookings': 'Booking Management', 'editor': 'Website Content', 'settings': 'System Settings' };
      document.getElementById('pageTitle').innerText = titles[tabId];
    };

    window.closeModal = (id) => document.getElementById(id).classList.remove('active');
    
    window.goToSite = () => {
      localStorage.setItem('isManager', 'true'); // Allow editing on frontend
      window.location.href = '/';
    };

    // --- DATA LOADING ---
    async function loadData() {
      await Promise.all([loadBookings(), loadPackages(), loadSettings()]);
    }

    async function loadBookings() {
      try {
        const q = query(collection(db, 'bookings')); // Load all for manager
        const snapshot = await getDocs(q);
        bookingsData = [];
        let revenue = 0;
        
        snapshot.forEach(doc => {
            const data = doc.data();
            bookingsData.push({ id: doc.id, ...data });
            if(data.status === 'confirmed' || data.status === 'completed') {
                // Approximate revenue if price exists, else estimate
                revenue += (parseInt(data.price) || 1500); 
            }
        });

        // Sort by date (newest first)
        bookingsData.sort((a, b) => new Date(b.createdAt?.toDate?.() || 0) - new Date(a.createdAt?.toDate?.() || 0));

        updateDashboard();
        renderBookingsTable(bookingsData);
      } catch (e) {
        console.error(e);
        showToast("Error loading bookings", 'error');
      }
    }

    function updateDashboard() {
      const total = bookingsData.length;
      const pending = bookingsData.filter(b => b.status === 'pending').length;
      const confirmed = bookingsData.filter(b => b.status === 'confirmed').length;

      document.getElementById('statTotal').innerText = total;
      document.getElementById('statPending').innerText = pending;
      document.getElementById('statConfirmed').innerText = confirmed;
      document.getElementById('statRevenue').innerText = '₹' + confirmed * 1500; // rough estimate logic

      const badge = document.getElementById('pendingCountBadge');
      if (pending > 0) {
        badge.innerText = pending;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      // Render Recent Table
      const tbody = document.getElementById('dashboardTableBody');
      tbody.innerHTML = '';
      bookingsData.slice(0, 5).forEach(b => {
        tbody.innerHTML += `
          <tr>
            <td>
                <div style="font-weight:600">${b.name}</div>
                <div style="font-size:0.75rem; color:#64748B">${b.phone}</div>
            </td>
            <td>${b.tourPackage}</td>
            <td>${b.date}</td>
            <td><span class="status-badge status-${b.status || 'pending'}">${b.status || 'pending'}</span></td>
            <td><button class="btn-primary btn-sm btn-outline" onclick="switchTab('bookings')">Manage</button></td>
          </tr>
        `;
      });
    }

    window.filterBookings = (status) => {
        let filtered = bookingsData;
        if(status !== 'all') filtered = bookingsData.filter(b => b.status === status);
        renderBookingsTable(filtered);
    };

    function renderBookingsTable(data) {
        const tbody = document.getElementById('bookingsTableBody');
        if(data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">No bookings found</td></tr>';
            return;
        }
        tbody.innerHTML = data.map(b => `
          <tr>
            <td>#${b.id.substr(0,6)}</td>
            <td>
                <b>${b.name}</b><br>
                <small>${b.email || ''}</small>
            </td>
            <td><a href="tel:${b.phone}" style="color:var(--primary); text-decoration:none;">${b.phone}</a></td>
            <td>${b.tourPackage}<br><small>₹${b.price || ' - '}</small></td>
            <td><span class="status-badge status-${b.status || 'pending'}">${b.status || 'pending'}</span></td>
            <td>
                ${b.status === 'pending' ? 
                  `<button class="btn-primary btn-sm" onclick="updateStatus('${b.id}', 'confirmed')">Confirm</button>
                   <button class="btn-primary btn-sm btn-outline" style="color:red; border-color:red" onclick="updateStatus('${b.id}', 'cancelled')">Cancel</button>` 
                  : ''}
                ${b.status === 'confirmed' ? 
                  `<button class="btn-primary btn-sm" style="background:var(--info-text)" onclick="updateStatus('${b.id}', 'completed')">Complete</button>` 
                  : ''}
            </td>
          </tr>
        `).join('');
    }

    window.updateStatus = async (id, status) => {
        if(!confirm(`Mark booking as ${status}?`)) return;
        await updateDoc(doc(db, 'bookings', id), { status: status });
        showToast(`Booking marked as ${status}`);
        loadBookings();
    };

    // --- EDITOR LOGIC ---
    async function loadPackages() {
        try {
            const snap = await getDocs(collection(db, 'packages'));
            const container = document.getElementById('packagesList');
            container.innerHTML = '';
            
            if(snap.empty) {
                document.getElementById('seedDataAlert').style.display = 'flex';
                container.innerHTML = '<p style="text-align:center">No packages yet.</p>';
                return;
            }

            document.getElementById('seedDataAlert').style.display = 'none';
            snap.forEach(d => {
                const p = d.data();
                container.innerHTML += `
                    <div class="package-card">
                        <div class="pkg-info">
                            <h4>${p.name}</h4>
                            <p>${p.duration} • ${p.description ? p.description.substr(0,40)+'...' : ''}</p>
                        </div>
                        <div style="text-align:right">
                            <div class="pkg-price">₹${p.price}</div>
                            <div style="margin-top:5px">
                                <button class="btn-primary btn-sm btn-outline" onclick="editPackage('${d.id}')">Edit</button>
                                <button style="border:none; background:none; color:red; cursor:pointer;" onclick="deletePackage('${d.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            });
        } catch(e) { console.log(e); }
    }

    // Default Varanasi Data Seeding
    window.seedDefaultPackages = async () => {
        const defaults = [
            { name: "Morning Boat Ride (Subah-e-Banaras)", price: 1500, duration: "3 Hours", description: "Experience the magical sunrise on the Ganges with a guided boat tour covering main Ghats." },
            { name: "Kashi Vishwanath & Temple Tour", price: 1200, duration: "4 Hours", description: "Priority darshan assistance and guided tour of the Golden Temple and surrounding ancient alleys." },
            { name: "Sarnath Excursion", price: 2500, duration: "5 Hours", description: "Visit the Dhamek Stupa, Museum, and Deer Park where Buddha gave his first sermon. Scooter included." },
            { name: "Evening Aarti & Street Food", price: 1800, duration: "4 Hours", description: "Watch the spectacular Ganga Aarti at Dashashwamedh Ghat followed by a famous local food trail." }
        ];

        try {
            for(let p of defaults) {
                await setDoc(doc(collection(db, 'packages')), p);
            }
            showToast("Default Varanasi packages added!");
            loadPackages();
        } catch(e) { showToast("Error seeding data", "error"); }
    };

    window.openPackageModal = () => {
        document.getElementById('pkgModalTitle').innerText = 'Add New Package';
        document.getElementById('pkgId').value = '';
        document.getElementById('pkgName').value = '';
        document.getElementById('pkgPrice').value = '';
        document.getElementById('pkgDuration').value = '';
        document.getElementById('pkgDesc').value = '';
        document.getElementById('packageModal').classList.add('active');
    };

    window.editPackage = async (id) => {
        const d = await getDoc(doc(db, 'packages', id));
        const p = d.data();
        document.getElementById('pkgModalTitle').innerText = 'Edit Package';
        document.getElementById('pkgId').value = id;
        document.getElementById('pkgName').value = p.name;
        document.getElementById('pkgPrice').value = p.price;
        document.getElementById('pkgDuration').value = p.duration;
        document.getElementById('pkgDesc').value = p.description;
        document.getElementById('packageModal').classList.add('active');
    };

    window.savePackage = async () => {
        const id = document.getElementById('pkgId').value;
        const data = {
            name: document.getElementById('pkgName').value,
            price: Number(document.getElementById('pkgPrice').value),
            duration: document.getElementById('pkgDuration').value,
            description: document.getElementById('pkgDesc').value
        };

        if(id) {
            await updateDoc(doc(db, 'packages', id), data);
        } else {
            await setDoc(doc(collection(db, 'packages')), data);
        }
        closeModal('packageModal');
        loadPackages();
        showToast("Package saved!");
    };

    window.deletePackage = async(id) => {
        if(confirm("Delete this package?")) {
            await deleteDoc(doc(db, 'packages', id));
            loadPackages();
        }
    };

    // Images
    async function loadSettings() {
        const docRef = doc(db, 'settings', 'website');
        const snap = await getDoc(docRef);
        
        if(snap.exists()) {
            websiteSettings = snap.data();
            
            // Render Images
            const imgContainer = document.getElementById('imageGallery');
            imgContainer.innerHTML = '';
            const images = websiteSettings.images || {
                hero: 'https://images.unsplash.com/photo-1561361513-2d000a50f0dc?w=800', // Varanasi boat
                about: 'https://images.unsplash.com/photo-1590050752117-238cb0fb12b1?w=800', // Ghats
                scooter: 'https://images.unsplash.com/photo-1558981403-c5f9899a28bc?w=800' // Bike
            };

            Object.keys(images).forEach(key => {
                imgContainer.innerHTML += `
                    <div class="img-tile" onclick="openImageModal('${key}', '${images[key]}')">
                        <img src="${images[key]}" alt="${key}">
                        <div class="img-overlay"><i class="fas fa-camera" style="color:white; font-size:1.5rem"></i></div>
                        <div class="img-label">${key.toUpperCase()}</div>
                    </div>
                `;
            });

            // Form Fill
            if(websiteSettings.contact) {
                document.getElementById('editPhone').value = websiteSettings.contact.phone || '';
                document.getElementById('editWhatsapp').value = websiteSettings.contact.whatsapp || '';
                document.getElementById('editEmail').value = websiteSettings.contact.email || '';
            }
        } else {
            // Create default settings if missing
             await setDoc(docRef, {
                 images: { hero: '', about: '' },
                 contact: { phone: '', email: '' }
             });
             loadSettings();
        }
    }

    window.openImageModal = (key, currentUrl) => {
        document.getElementById('imgModalLabel').innerText = `Editing section: ${key}`;
        document.getElementById('imgKey').value = key;
        document.getElementById('newImgUrl').value = currentUrl;
        document.getElementById('imgPreview').src = currentUrl;
        document.getElementById('imageModal').classList.add('active');
    };

    window.saveImage = async () => {
        const key = document.getElementById('imgKey').value;
        const url = document.getElementById('newImgUrl').value;
        
        const settingsRef = doc(db, 'settings', 'website');
        const snap = await getDoc(settingsRef);
        let currentImages = snap.data().images || {};
        currentImages[key] = url;

        await updateDoc(settingsRef, { images: currentImages });
        closeModal('imageModal');
        showToast("Image updated!");
        loadSettings();
    };

    window.saveContactInfo = async () => {
        const data = {
            contact: {
                phone: document.getElementById('editPhone').value,
                whatsapp: document.getElementById('editWhatsapp').value,
                email: document.getElementById('editEmail').value
            }
        };
        await updateDoc(doc(db, 'settings', 'website'), data);
        showToast("Contact info updated");
    };

    // --- AUTH ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Strict Manager Check
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().role === 'manager') {
            currentUser = user;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userNameDisplay').innerText = userDoc.data().name || 'Manager';
            document.getElementById('userEmailDisplay').innerText = user.email;
            document.getElementById('profileName').value = userDoc.data().name || '';
            
            // Setup mobile nav listener
            document.querySelectorAll('.nav-item').forEach(el => {
                el.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('open'); // close on mobile
                });
            });

            loadData();
        } else {
            alert("Access Denied: Manager privileges required.");
            signOut(auth);
            window.location.href = '/login.html';
        }
      } else {
        window.location.href = '/login.html';
      }
    });

    window.logout = () => signOut(auth);
    
    window.refreshData = () => {
        showToast("Refreshing data...");
        loadData();
    }

    // Mobile Toggle
    document.addEventListener('DOMContentLoaded', () => {
        const toggle = document.getElementById('menuToggle');
        if(window.innerWidth <= 768) toggle.style.display = 'block';
        toggle.addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('open');
        });
    });

  </script>
</body>
</html>
